<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Constrained Model fitting | Fatima Kahil</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/html4css1.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://fakahil.github.io/science/constrained-model-fitting/index.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Fatima Kahil">
<meta property="og:site_name" content="Fatima Kahil">
<meta property="og:title" content="Constrained Model fitting">
<meta property="og:url" content="https://fakahil.github.io/science/constrained-model-fitting/index.html">
<meta property="og:description" content="Curve fitting - Constraints¶






Sometimes we need to put some constraints on the problem, meaning that we would like to have a set of best-fit parameters which correspond to some wanted conditions,">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-04-04T20:22:21+02:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://fakahil.github.io/">

                <span id="blog-title">Fatima Kahil</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" role="navigation" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../blog/">Blog</a>
                </li>
<li>
<a href="../../journal/">Journal</a>
                </li>
<li>
<a href="../">Coding</a>
                </li>
<li>
<a href="../../arabic/">عربي</a>
                </li>
<li>
<a href="../../about-me/">Contact</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.ipynb" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Constrained Model fitting</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Fatima Kahil
            </span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2020-04-04T20:22:21+02:00" itemprop="datePublished" title="2020-04-04 20:22">2020-04-04 20:22</time></a></p>
            
        <p class="sourceline"><a href="index.ipynb" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Curve-fitting---Constraints">Curve fitting - Constraints<a class="anchor-link" href="index.html#Curve-fitting---Constraints">¶</a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Sometimes-we-need-to-put-some-constraints-on-the-problem,-meaning-that-we-would-like-to-have-a-set-of-best-fit-parameters-which-correspond-to-some-wanted-conditions,-usually-more-sophisticated-than-just-introducing-bounds.">Sometimes we need to put some constraints on the problem, meaning that we would like to have a set of best-fit parameters which correspond to some wanted conditions, usually more sophisticated than just introducing bounds.<a class="anchor-link" href="index.html#Sometimes-we-need-to-put-some-constraints-on-the-problem,-meaning-that-we-would-like-to-have-a-set-of-best-fit-parameters-which-correspond-to-some-wanted-conditions,-usually-more-sophisticated-than-just-introducing-bounds.">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Let's-start-with-defining-the-objective-function-and-Jacobian-matrix.-The-fitting-function-we-will-use-is-scipy.optimize.minimize.-It-is-the-only-function-that-I-found-which-takes-complicated-constraints.">Let's start with defining the objective function and Jacobian matrix. The fitting function we will use is <strong><a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html">scipy.optimize.minimize</a></strong>. It is the only function that I found which takes complicated constraints.<a class="anchor-link" href="index.html#Let's-start-with-defining-the-objective-function-and-Jacobian-matrix.-The-fitting-function-we-will-use-is-scipy.optimize.minimize.-It-is-the-only-function-that-I-found-which-takes-complicated-constraints.">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">special</span>
<span class="kn">import</span> <span class="nn">pyfits</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1">## the model</span>

<span class="k">def</span> <span class="nf">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">):</span>

 <span class="n">y</span> <span class="o">=</span> <span class="n">special</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
 <span class="k">return</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">SL_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">w3</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">):</span>

  <span class="n">f</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">w1</span><span class="o">*</span><span class="n">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s1</span><span class="p">)</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span><span class="o">+</span><span class="n">w3</span><span class="o">*</span><span class="n">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span><span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w1</span><span class="o">-</span><span class="n">w2</span><span class="o">-</span><span class="n">w3</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">f</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1">## the customised objective function for the minimize function.</span>
<span class="k">def</span> <span class="nf">Minimize</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>
 
 <span class="n">w1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 <span class="n">w2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="n">w3</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
 <span class="n">s1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
 <span class="n">s2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
 <span class="n">s3</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
 <span class="n">model</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">w1</span><span class="o">*</span><span class="n">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s1</span><span class="p">)</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span><span class="o">+</span><span class="n">w3</span><span class="o">*</span><span class="n">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w1</span><span class="o">-</span><span class="n">w2</span><span class="o">-</span><span class="n">w3</span><span class="p">))</span>
 <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="mi">1</span><span class="o">/</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">model</span><span class="o">-</span><span class="n">y</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1">## The Jacobian matrix</span>
<span class="k">def</span> <span class="nf">Jac</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>
 <span class="n">w1</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 <span class="n">w2</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="n">w3</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
 <span class="n">s1</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
 <span class="n">s2</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
 <span class="n">s3</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

 <span class="n">dfw1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">SL_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">w3</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
 <span class="n">dfw2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">SL_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">w3</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
 <span class="n">dfw3</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">SL_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">w3</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Erfc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
 <span class="n">dfs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">SL_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">w3</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">w1</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
 <span class="n">dfs2</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">SL_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">w3</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">w2</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">s2</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">s2</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
 <span class="n">dfs3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">SL_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">w3</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">w3</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">s3</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">s3</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
 <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dfw1</span><span class="p">,</span><span class="n">dfw2</span><span class="p">,</span><span class="n">dfw3</span><span class="p">,</span><span class="n">dfs1</span><span class="p">,</span><span class="n">dfs2</span><span class="p">,</span><span class="n">dfs3</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s2">"/home/fatima/Desktop/project_3/"</span>
<span class="nb">file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">'limb_profile_av_norm_shifted'</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">file</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="nb">file</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="c1">#p0=[0.3, 0.3, 0.2, 1, 2, 3]</span>
<span class="n">p0</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.544</span><span class="p">,</span><span class="mf">0.291</span><span class="p">,</span><span class="mf">0.068</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">4.7</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="For-unconstrained-fit,-the-minimize-function-is-called.-Note-that-the-args-parameter-of-the-function-should-have-the-same-format-as-the-parameters-passed-to-the-objective-function.">For unconstrained fit, the minimize function is called. Note that the args parameter of the function should have the same format as the parameters passed to the objective function.<a class="anchor-link" href="index.html#For-unconstrained-fit,-the-minimize-function-is-called.-Note-that-the-args-parameter-of-the-function-should-have-the-same-format-as-the-parameters-passed-to-the-objective-function.">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">mini</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">Minimize</span><span class="p">,</span><span class="n">p0</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">weights</span><span class="p">),</span><span class="n">jac</span><span class="o">=</span><span class="n">Jac</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'xtol'</span><span class="p">:</span><span class="mf">1e-8</span><span class="p">,</span><span class="s1">'gtol'</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span><span class="s1">'maxit'</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
<span class="k">print</span> <span class="n">mini</span><span class="o">.</span><span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Optimization terminated successfully.
         Current function value: 0.001221
         Iterations: 40
         Function evaluations: 51
         Gradient evaluations: 51
[ 0.52750273  0.28882469  0.10191702  0.25905394  0.76540951  2.83344876]
</pre>
</div>
</div>

<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stderr output_text">
<pre>/usr/local/lib/python2.7/dist-packages/ipykernel_launcher.py:1: OptimizeWarning: Unknown solver options: xtol, maxit
  """Entry point for launching an IPython kernel.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Now-let's-introduce-some-easy-defined-constraints.-Usually-the-defined-constraint-function-which--will-be-passed-later-to-the-fitting-function-minimize,-returns-a-zero-or-a-positive-value.-For-example-if-we-want-to-have-the-parameter-s2-to-be-larger-than-s1-in-the-resultant-fitting-process,-we-can-type-the-following:">Now let's introduce some easy-defined constraints. Usually the defined constraint function which  will be passed later to the fitting function minimize, returns a zero or a positive value. For example if we want to have the parameter s2 to be larger than s1 in the resultant fitting process, we can type the following:<a class="anchor-link" href="index.html#Now-let's-introduce-some-easy-defined-constraints.-Usually-the-defined-constraint-function-which--will-be-passed-later-to-the-fitting-function-minimize,-returns-a-zero-or-a-positive-value.-For-example-if-we-want-to-have-the-parameter-s2-to-be-larger-than-s1-in-the-resultant-fitting-process,-we-can-type-the-following:">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="k">def</span> <span class="nf">Con_1</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
 <span class="n">w1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 <span class="n">w2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="n">w3</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
 <span class="n">w4</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">w1</span><span class="o">+</span><span class="n">w2</span><span class="o">+</span><span class="n">w3</span><span class="p">)</span>
 <span class="n">s1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
 <span class="n">s2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
 <span class="n">s3</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> 
 <span class="k">return</span> <span class="n">s2</span><span class="o">-</span><span class="n">s1</span>    
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="And-then-we-add-this-constraint-function-to-the-object-cons-and-specify-whether-it-is-an-equality-or-inequality-constraint.--The-reason-for-defining-this-object-is-to-include-as-many-constraint-functions-as-possible.-This-object-is-passed-to-the-function-minimize-under-the-parameter-constraints.">And then we add this constraint function to the object <em>cons</em> and specify whether it is an equality or inequality constraint.  The reason for defining this object is to include as many constraint functions as possible. This object is passed to the function minimize under the parameter <em>constraints</em>.<a class="anchor-link" href="index.html#And-then-we-add-this-constraint-function-to-the-object-cons-and-specify-whether-it-is-an-equality-or-inequality-constraint.--The-reason-for-defining-this-object-is-to-include-as-many-constraint-functions-as-possible.-This-object-is-passed-to-the-function-minimize-under-the-parameter-constraints.">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">cons</span> <span class="o">=</span> <span class="p">({</span><span class="s1">'type'</span><span class="p">:</span><span class="s1">'ineq'</span><span class="p">,</span><span class="s1">'fun'</span><span class="p">:</span><span class="n">Con_1</span><span class="p">})</span> <span class="c1">##this tells minimize that we want the returned value of the constraint function should be positive</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Now-we-pass-this-constraint-to-minimize-but-we-have-to-also-change-the-method-of-optimization-which-is-defined-for-constrained-problems.-Check-scipy.optimize.minimize-for-more-details-on-the-optimization-methods-available.">Now we pass this constraint to <em>minimize</em> but we have to also change the method of optimization which is defined for constrained problems. Check <strong><a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html">scipy.optimize.minimize</a></strong> for more details on the optimization methods available.<a class="anchor-link" href="index.html#Now-we-pass-this-constraint-to-minimize-but-we-have-to-also-change-the-method-of-optimization-which-is-defined-for-constrained-problems.-Check-scipy.optimize.minimize-for-more-details-on-the-optimization-methods-available.">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">mini</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">Minimize</span><span class="p">,</span><span class="n">p0</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">weights</span><span class="p">),</span><span class="n">jac</span><span class="o">=</span><span class="n">Jac</span><span class="p">,</span><span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'xtol'</span><span class="p">:</span><span class="mf">1e-8</span><span class="p">,</span><span class="s1">'gtol'</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span><span class="s1">'maxit'</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
<span class="n">popt</span> <span class="o">=</span> <span class="n">mini</span><span class="o">.</span><span class="n">x</span> <span class="c1">## the best-fit parameters</span>
<span class="k">print</span> <span class="n">popt</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Optimization terminated successfully.    (Exit mode 0)
            Current function value: 0.00233234740213
            Iterations: 8
            Function evaluations: 17
            Gradient evaluations: 8
[ 0.56554532  0.27822938  0.09418257  0.27118045  0.8841216   4.69687872]
</pre>
</div>
</div>

<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stderr output_text">
<pre>/usr/local/lib/python2.7/dist-packages/ipykernel_launcher.py:2: OptimizeWarning: Unknown solver options: xtol, maxit, gtol
  
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Now-I-will-introduce-a-more-complicated-constraint-function.-For-a-better-understanding-of-this-function,-I-recommend-going-back-to--data_cleaning-which-explaines-how-to-use-the-model-introduced-here-to-cleaning-my-data-for-stray-light.">Now I will introduce a more complicated constraint function. For a better understanding of this function, I recommend going back to  <strong><a href="https://github.com/fakahil/Projects/blob/master/cleaning_data.ipynb">data_cleaning</a></strong> which explaines how to use the model introduced here to cleaning my data for stray light.<a class="anchor-link" href="index.html#Now-I-will-introduce-a-more-complicated-constraint-function.-For-a-better-understanding-of-this-function,-I-recommend-going-back-to--data_cleaning-which-explaines-how-to-use-the-model-introduced-here-to-cleaning-my-data-for-stray-light.">¶</a>
</h4>
<h4 id="In-my-project,-I-have-used-this-constraint-function-to-force-minimize-to-fit-the-model-to-the-data-in-a-way-that-the-RMS-contrast-(check-RMS_contrast)-of-the-corrected-image-should-be-equal-to-a-certain-value,-usually-that-returned-by-theoretical-expectations-(Magnetohydrodynamical-simulations-of-the-solar-convection).">In my project, I have used this constraint function to force minimize to fit the model to the data in a way that the RMS contrast (check <strong><a href="https://github.com/fakahil/PhD-codes-and-functions/blob/master/RMS_contrast.ipynb">RMS_contrast</a></strong>) of the corrected image should be equal to a certain value, usually that returned by theoretical expectations (Magnetohydrodynamical simulations of the solar convection).<a class="anchor-link" href="index.html#In-my-project,-I-have-used-this-constraint-function-to-force-minimize-to-fit-the-model-to-the-data-in-a-way-that-the-RMS-contrast-(check-RMS_contrast)-of-the-corrected-image-should-be-equal-to-a-certain-value,-usually-that-returned-by-theoretical-expectations-(Magnetohydrodynamical-simulations-of-the-solar-convection).">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1">## Here I am loading the image to be corrected and embedding it to preparing it for use by the constraint function</span>

<span class="n">image</span> <span class="o">=</span> <span class="s1">'sufi300_lev3_2009.fits'</span>
<span class="n">imscale</span><span class="o">=</span><span class="mf">0.0198</span>
<span class="n">Input</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="n">image</span><span class="p">,</span> <span class="n">ignore_missing_header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">w_in</span> <span class="o">=</span> <span class="n">Input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">h_in</span> <span class="o">=</span> <span class="n">Input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Input_emb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h_in</span><span class="p">,</span><span class="n">h_in</span><span class="p">))</span>
<span class="n">Input_emb</span><span class="p">[:,(</span><span class="n">h_in</span><span class="o">-</span><span class="n">w_in</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:(</span><span class="n">h_in</span><span class="o">+</span><span class="n">w_in</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Input</span>  
<span class="n">mtf_pd</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">'MTF_PD_large.fits'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">freqscale</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">h_in</span><span class="o">*</span><span class="n">imscale</span><span class="p">)</span>
<span class="n">otf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h_in</span><span class="p">,</span><span class="n">h_in</span><span class="p">))</span>
<span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">([</span><span class="n">h_in</span><span class="p">,</span><span class="n">h_in</span><span class="p">])</span><span class="o">*</span><span class="n">freqscale</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">i</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">j</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span>
<span class="n">xc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">yc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">yc</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1">## The constraint function</span>
<span class="k">def</span> <span class="nf">Con</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
 <span class="n">w1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 <span class="n">w2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="n">w3</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
 <span class="n">w4</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">w1</span><span class="o">+</span><span class="n">w2</span><span class="o">+</span><span class="n">w3</span><span class="p">)</span>
 <span class="n">s1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
 <span class="n">s2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
 <span class="n">s3</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
 <span class="n">s_t</span> <span class="o">=</span> <span class="n">s1</span>
 <span class="n">ss2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
 <span class="n">ss3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s3</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
 <span class="n">otf</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">mtf_pd</span><span class="o">+</span><span class="n">w2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ss2</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">+</span><span class="n">w3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span><span class="n">ss3</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
 <span class="n">otf</span><span class="p">[</span><span class="n">yc</span><span class="p">,</span><span class="n">xc</span><span class="p">]</span> <span class="o">=</span> <span class="n">otf</span><span class="p">[</span><span class="n">yc</span><span class="p">,</span><span class="n">xc</span><span class="p">]</span><span class="o">+</span><span class="n">w4</span>
 <span class="n">ind_ne_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mtf_pd</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">ind_eq_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mtf_pd</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">otf</span><span class="p">[</span><span class="n">ind_ne_0</span><span class="p">]</span> <span class="o">=</span> <span class="n">otf</span><span class="p">[</span><span class="n">ind_ne_0</span><span class="p">]</span><span class="o">/</span><span class="n">mtf_pd</span><span class="p">[</span><span class="n">ind_ne_0</span><span class="p">]</span>
 <span class="n">otf</span><span class="p">[</span><span class="n">ind_eq_0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w1</span>
 <span class="n">otf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">otf</span><span class="p">)</span>
 <span class="n">Input_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">Input_emb</span><span class="p">)</span>
 <span class="n">Input_deconv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">Input_fft</span><span class="o">/</span><span class="n">otf</span><span class="p">))</span>
 <span class="n">Input_deconv</span> <span class="o">=</span> <span class="n">Input_deconv</span><span class="p">[:,(</span><span class="n">h_in</span><span class="o">-</span><span class="n">w_in</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:(</span><span class="n">h_in</span><span class="o">+</span><span class="n">w_in</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
 <span class="n">RMS</span> <span class="o">=</span> <span class="n">Input_deconv</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">Input_deconv</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
 <span class="k">return</span> <span class="mf">0.3</span><span class="o">-</span><span class="n">RMS</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="As-you-can-notice,-everytime-minimize-performs-the-least-square-fitting,-it-should-returns-the-computed-parameters-to-the-constaint-function,-Con-to-build-the-total-PSF,-decovolve-the-science-image-with-it-and-test-the-returned-RMS-value-of-the-corrected-image-if-it's-equal-to-0.3-or-not,-so-it-is-computationally-expensive.">As you can notice, everytime <em>minimize</em> performs the least-square fitting, it should returns the computed parameters to the constaint function, <em>Con</em> to build the total PSF, decovolve the science image with it and test the returned RMS value of the corrected image if it's equal to 0.3 or not, so it is computationally expensive.<a class="anchor-link" href="index.html#As-you-can-notice,-everytime-minimize-performs-the-least-square-fitting,-it-should-returns-the-computed-parameters-to-the-constaint-function,-Con-to-build-the-total-PSF,-decovolve-the-science-image-with-it-and-test-the-returned-RMS-value-of-the-corrected-image-if-it's-equal-to-0.3-or-not,-so-it-is-computationally-expensive.">¶</a>
</h4>
<h4 id="Now-we-construct-the-cons-object:">Now we construct the <em>cons</em> object:<a class="anchor-link" href="index.html#Now-we-construct-the-cons-object:">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">cons</span> <span class="o">=</span> <span class="p">({</span><span class="s1">'type'</span><span class="p">:</span><span class="s1">'eq'</span><span class="p">,</span><span class="s1">'fun'</span><span class="p">:</span><span class="n">Con</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">mini</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">Minimize</span><span class="p">,</span><span class="n">p0</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">weights</span><span class="p">),</span><span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'xtol'</span><span class="p">:</span><span class="mf">1e-8</span><span class="p">,</span><span class="s1">'gtol'</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span><span class="s1">'maxit'</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Since-the-returned-value-by-the-objective-function-Minimize-is-the-chi-squared-value-(check-the-expression-of-the-objective-function),-we-can-compute-the-chi-squared-value-like-this">Since the returned value by the objective function Minimize is the chi-squared value (check the expression of the objective function), we can compute the chi-squared value like this<a class="anchor-link" href="index.html#Since-the-returned-value-by-the-objective-function-Minimize-is-the-chi-squared-value-(check-the-expression-of-the-objective-function),-we-can-compute-the-chi-squared-value-like-this">¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="n">chi_sq</span> <span class="o">=</span> <span class="n">Minimize</span><span class="p">(</span><span class="n">mini</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">weights</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    </div>
  </div>

    </div>
    <aside class="postpromonav"><nav></nav></aside><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-SDRP1VVYu+tgAGKhddBSl5+ezofHKZeI+OzxakbIe/Y=" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']]}});
        </script></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2020         <a href="mailto:fakahil92@gmail.com">Fatima Kahil</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/moment-with-locales.min.js"></script><script src="../../assets/js/fancydates.js"></script><script src="../../assets/js/jquery.colorbox-min.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
